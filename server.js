const express = require('express');
const cors = require('cors');
const admin = require('firebase-admin');
const bcrypt = require('bcrypt');

const SALT_ROUNDS = 10;

const app = express();
app.use(cors());
app.use(express.json());

// ======= Firebase Setup =======
// const serviceAccount = require('./serviceAccountKey.json');

// à¸«à¸£à¸·à¸­à¸–à¹‰à¸²à¹ƒà¸Šà¹‰ ENV
const serviceAccount = JSON.parse(process.env.FIREBASE_SERVICE_ACCOUNT);

serviceAccount.private_key = serviceAccount.private_key.replace(/\\n/g, '\n');

admin.initializeApp({
  credential: admin.credential.cert(serviceAccount),
  databaseURL: "https://mueangchonburi-c9438-default-rtdb.asia-southeast1.firebasedatabase.app"
});

const db = admin.database();

// ======= Routes =======

// Health Check
app.get('/', (req, res) => {
  res.send('âœ… Backend OK - Firebase Realtime Database');
});

// GET items
app.get('/items', (req, res) => {
  const ref = db.ref('items');
  ref.once('value')
    .then(snapshot => {
      res.json(snapshot.val() || {});
    })
    .catch(err => {
      console.error('[FIREBASE ERROR]', err);
      res.status(500).send('à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸žà¸¥à¸²à¸”');
    });
});

// POST item
app.post('/items', (req, res) => {
  const { name } = req.body;
  if (!name) return res.status(400).send('à¸à¸£à¸¸à¸“à¸²à¸ªà¹ˆà¸‡ name à¸”à¹‰à¸§à¸¢');

  const ref = db.ref('items').push();
  ref
    .set({ name })
    .then(() => res.status(201).json({ id: ref.key, name }))
    .catch(err => {
      console.error('Write failed:', err);
      res.status(500).send('à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸žà¸¥à¸²à¸”à¹ƒà¸™à¸à¸²à¸£à¸šà¸±à¸™à¸—à¸¶à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥');
    });
});

// GET Users
app.get('/Users', (req, res) => {
  const ref = db.ref('users');
  ref.once('value')
    .then(snapshot => {
      res.json(snapshot.val() || {});
    })
    .catch(err => {
      console.error('[FIREBASE ERROR]', err);
      res.status(500).send('à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸žà¸¥à¸²à¸”');
    });
});

// ======= Register =======
app.post('/register', async (req, res) => {
  const { username, password, name, email, role } = req.body;

  if (!username || !password || !name || !email || !role) {
    return res.status(400).json({ error: 'à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹„à¸¡à¹ˆà¸„à¸£à¸šà¸–à¹‰à¸§à¸™' });
  }

  try {
    const ref = db.ref('users');

    const snapshot = await ref.once('value');
    const users = snapshot.val() || {};

    const isDuplicate = Object.values(users).some(u => u.Username === username);
    if (isDuplicate) {
      return res.status(409).json({ error: 'Username à¸™à¸µà¹‰à¸–à¸¹à¸à¹ƒà¸Šà¹‰à¹à¸¥à¹‰à¸§' });
    }

    let maxId = 0;
    Object.values(users).forEach(u => {
      const idNum = parseInt(u.UserId);
      if (!isNaN(idNum) && idNum > maxId) maxId = idNum;
    });
    const newUserId = maxId + 1;

    const hashedPassword = await bcrypt.hash(password, SALT_ROUNDS);
    const now = new Date().toISOString();

    const newUserRef = ref.push();
    await newUserRef.set({
      UserId: newUserId.toString(),
      Username: username,
      Password: hashedPassword,
      Name: name,
      Email: email,
      Role: role,
      created_at: now
    });

    res.status(201).json({ id: newUserRef.key, UserId: newUserId });
  } catch (err) {
    console.error('[REGISTER ERROR]', err);
    res.status(500).json({ error: 'à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸žà¸¥à¸²à¸”à¹ƒà¸™à¸à¸±à¹ˆà¸‡à¹€à¸‹à¸´à¸£à¹Œà¸Ÿà¹€à¸§à¸­à¸£à¹Œ' });
  }
});

// ======= Login =======
app.post('/login', async (req, res) => {
  const { username, password } = req.body;

  if (!username || !password) {
    return res.status(400).json({ error: 'à¸à¸£à¸¸à¸“à¸²à¸à¸£à¸­à¸à¸Šà¸·à¹ˆà¸­à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¹à¸¥à¸°à¸£à¸«à¸±à¸ªà¸œà¹ˆà¸²à¸™' });
  }

  try {
    const ref = db.ref('users');
    const snapshot = await ref.once('value');
    const users = snapshot.val() || {};

    const user = Object.values(users).find(u => u.Username === username);
    if (!user) {
      return res.status(401).json({ error: 'à¸Šà¸·à¹ˆà¸­à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¸«à¸£à¸·à¸­à¸£à¸«à¸±à¸ªà¸œà¹ˆà¸²à¸™à¹„à¸¡à¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡' });
    }

    const match = await bcrypt.compare(password, user.Password);
    if (!match) {
      return res.status(401).json({ error: 'à¸Šà¸·à¹ˆà¸­à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¸«à¸£à¸·à¸­à¸£à¸«à¸±à¸ªà¸œà¹ˆà¸²à¸™à¹„à¸¡à¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡' });
    }

    res.status(200).json({
      message: 'à¹€à¸‚à¹‰à¸²à¸ªà¸¹à¹ˆà¸£à¸°à¸šà¸šà¸ªà¸³à¹€à¸£à¹‡à¸ˆ',
      user: {
        UserId: user.UserId,
        Username: user.Username,
        Name: user.Name,
        Email: user.Email,
        Role: user.Role
      }
    });

  } catch (err) {
    console.error('[LOGIN ERROR]', err);
    res.status(500).json({ error: 'à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸žà¸¥à¸²à¸”à¹ƒà¸™à¸à¸±à¹ˆà¸‡à¹€à¸‹à¸´à¸£à¹Œà¸Ÿà¹€à¸§à¸­à¸£à¹Œ' });
  }
});

// ======= Update User =======
app.put('/users/:id', async (req, res) => {
  const userId = req.params.id; // Firebase push key
  const { name, email, role } = req.body;

  if (!name && !email && !role) {
    return res.status(400).json({ error: 'à¸à¸£à¸¸à¸“à¸²à¸ªà¹ˆà¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸µà¹ˆà¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¹à¸à¹‰à¹„à¸‚' });
  }

  try {
    const ref = db.ref(`users/${userId}`);

    const snapshot = await ref.once('value');
    if (!snapshot.exists()) {
      return res.status(404).json({ error: 'à¹„à¸¡à¹ˆà¸žà¸šà¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¸™à¸µà¹‰' });
    }

    const updates = {};
    if (name) updates.Name = name;
    if (email) updates.Email = email;
    if (role) updates.Role = role;

    await ref.update(updates);

    res.status(200).json({ message: 'à¸­à¸±à¸›à¹€à¸”à¸•à¸ªà¸³à¹€à¸£à¹‡à¸ˆ', updates });
  } catch (err) {
    console.error('[UPDATE ERROR]', err);
    res.status(500).json({ error: 'à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸žà¸¥à¸²à¸”à¹ƒà¸™à¸à¸±à¹ˆà¸‡à¹€à¸‹à¸´à¸£à¹Œà¸Ÿà¹€à¸§à¸­à¸£à¹Œ' });
  }
});

// ======= Delete User =======
app.delete('/users/:id', async (req, res) => {
  const userId = req.params.id; // Firebase push key

  try {
    const ref = db.ref(`users/${userId}`);

    const snapshot = await ref.once('value');
    if (!snapshot.exists()) {
      return res.status(404).json({ error: 'à¹„à¸¡à¹ˆà¸žà¸šà¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¸™à¸µà¹‰' });
    }

    await ref.remove();

    res.status(200).json({ message: 'à¸¥à¸šà¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¸ªà¸³à¹€à¸£à¹‡à¸ˆ' });
  } catch (err) {
    console.error('[DELETE ERROR]', err);
    res.status(500).json({ error: 'à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸žà¸¥à¸²à¸”à¹ƒà¸™à¸à¸±à¹ˆà¸‡à¹€à¸‹à¸´à¸£à¹Œà¸Ÿà¹€à¸§à¸­à¸£à¹Œ' });
  }
});

// ======= Fallback =======
app.use((req, res) => {
  res.status(404).send('à¹„à¸¡à¹ˆà¸žà¸šà¹€à¸ªà¹‰à¸™à¸—à¸²à¸‡à¸™à¸µà¹‰');
});

// ======= Start =======
const PORT = process.env.PORT || 3000;
app.listen(PORT, () => console.log(`ðŸš€ Server running on http://localhost:${PORT}`));
